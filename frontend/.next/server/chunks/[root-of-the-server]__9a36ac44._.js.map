{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 55, "column": 0}, "map": {"version":3,"sources":["file:///Users/taha/.gemini/antigravity/scratch/clawpazar/frontend/app/api/chat/route.ts"],"sourcesContent":["// ClawPazar â€“ Server-side LLM proxy for Agent Chat\n// Uses Zhipu AI GLM-5.0-72B via OpenAI-compatible endpoint\n// Streams responses back to the client via SSE\n\nimport { NextRequest, NextResponse } from 'next/server';\n\n/* â”€â”€ System Prompt â”€â”€ */\n\nconst SYSTEM_PROMPT = `Sen ClawPazar AjanÄ±sÄ±n â€” TÃ¼rkiye'nin en gÃ¼venilir ikinci el alÄ±ÅŸveriÅŸ platformunun AI asistanÄ±.\n\n## KÄ°MLÄ°ÄžÄ°N\n- AdÄ±n: ClawPazar Ajan\n- GÃ¶revin: KullanÄ±cÄ±lara ikinci el Ã¼rÃ¼n satmalarÄ± konusunda adÄ±m adÄ±m yardÄ±mcÄ± olmak\n- KiÅŸiliÄŸin: Samimi, profesyonel, hÄ±zlÄ± ve gÃ¼venilir. Emoji kullan ama abartma.\n\n## TEMEL KURALLAR\n1. **AynÄ± soruyu ASLA tekrarlama.** KullanÄ±cÄ±nÄ±n daha Ã¶nce verdiÄŸi bilgileri hatÄ±rla ve tekrar sorma.\n2. **HÄ±zlÄ± ve net ol.** Gereksiz uzun cÃ¼mleler kurma. Her mesajÄ±nda bir sonraki adÄ±mÄ± belirt.\n3. **TÃ¼rkÃ§e yanÄ±t ver.** DoÄŸal, konuÅŸma dilinde TÃ¼rkÃ§e kullan.\n\n## Ä°LAN OLUÅžTURMA AKIÅžI\nBilgi toplama sÄ±rasÄ± (eksik olanlarÄ± sor, tamamlanmÄ±ÅŸ olanlarÄ± tekrar sorma):\n1. **ÃœrÃ¼n**: Ne satÄ±lÄ±yor?\n2. **Marka/Model**: Hangi marka, hangi model?\n3. **Durum**: SÄ±fÄ±r / Ä°yi / Orta / KullanÄ±lmÄ±ÅŸ\n4. **Fiyat**: KaÃ§ TL isteniyor?\n5. **Konum**: Hangi ÅŸehir?\n6. **FotoÄŸraf**: \"Kamera butonuyla fotoÄŸraf ekleyebilirsiniz\" hatÄ±rlat\n\nHer adÄ±mda sadece eksik bilgileri sor. Birden fazla bilgi gelirse hepsini kaydet.\n\n## Ä°LAN TASLAÄžI\nTÃ¼m bilgiler toplandÄ±ÄŸÄ±nda ÅŸu formatta ilan taslaÄŸÄ± sun:\nðŸ“‹ **Ä°lan TaslaÄŸÄ±**\nðŸ“¦ ÃœrÃ¼n: [Ã¼rÃ¼n adÄ±]\nðŸ·ï¸ Marka/Model: [marka - model]\nðŸ“Š Durum: [durum]\nðŸ’° Fiyat: [fiyat]â‚º\nðŸ“ Konum: [ÅŸehir]\n\nSonra \"Ä°lanÄ± yayÄ±nlayayÄ±m mÄ±?\" diye sor.\n\n## KARGO AKIÅžI\nKullanÄ±cÄ± ilanÄ± onayladÄ±ktan sonra:\n- \"ðŸ“¦ Kargoyu ben ayarlayayÄ±m mÄ±? ClawPazar gÃ¼venli kargo sistemiyle Ã¼rÃ¼nÃ¼nÃ¼z sigortalÄ± gÃ¶nderilir.\"\n- Kargo seÃ§enekleri sun: PTT (39.90â‚º), MNG (49.90â‚º), YurtiÃ§i (54.90â‚º)\n- AlÄ±cÄ± Ã¶demeli / satÄ±cÄ± Ã¶demeli seÃ§eneÄŸi belirt\n\n## GÃœVENLÄ°K\n- **Escrow hatÄ±rlat**: \"ClawPazar'da Ã¶demeler escrow (gÃ¼venli havuz) sistemiyle korunur. AlÄ±cÄ± Ã¼rÃ¼nÃ¼ teslim alana kadar paranÄ±z gÃ¼vende.\"\n- **SahtekarlÄ±k uyarÄ±sÄ±**: ÅžÃ¼pheli fiyatlar (Ã§ok dÃ¼ÅŸÃ¼k), platform dÄ±ÅŸÄ± Ã¶deme talepleri, kiÅŸisel bilgi istekleri konusunda kullanÄ±cÄ±yÄ± uyar.\n- Asla kullanÄ±cÄ±nÄ±n kiÅŸisel bilgilerini (TC, banka bilgisi vb.) isteme.\n\n## YANITLAMA STÄ°LÄ°\n- KÄ±sa paragraflar kullan\n- Madde iÅŸaretleriyle bilgileri listele (â€¢ veya - kullan, markdown tablo kullanma)\n- Emoji ile gÃ¶rselleÅŸtir ama her cÃ¼mleye emoji koyma\n- Fiyat ve Ã¼rÃ¼n bilgilerini kalÄ±n yap`;\n\n/* â”€â”€ Types â”€â”€ */\n\ninterface ChatRequestBody {\n  messages: { role: string; content: string }[];\n}\n\n/* â”€â”€ Route Handler â”€â”€ */\n\nexport async function POST(req: NextRequest) {\n  const apiKey = process.env.ZHIPU_API_KEY;\n  const apiBase = process.env.ZHIPU_API_BASE || 'https://open.bigmodel.cn/api/paas/v4';\n  const model = process.env.ZHIPU_MODEL || 'glm-5.0-72b';\n\n  if (!apiKey) {\n    return NextResponse.json(\n      { error: 'LLM API key yapÄ±landÄ±rÄ±lmamÄ±ÅŸ. .env dosyasÄ±na ZHIPU_API_KEY ekleyin.' },\n      { status: 500 }\n    );\n  }\n\n  let body: ChatRequestBody;\n  try {\n    body = await req.json();\n  } catch {\n    return NextResponse.json({ error: 'GeÃ§ersiz istek gÃ¶vdesi' }, { status: 400 });\n  }\n\n  if (!body.messages || !Array.isArray(body.messages) || body.messages.length === 0) {\n    return NextResponse.json({ error: 'messages dizisi gerekli' }, { status: 400 });\n  }\n\n  // Build messages array with system prompt + conversation history\n  const llmMessages = [\n    { role: 'system', content: SYSTEM_PROMPT },\n    ...body.messages.map((m) => ({\n      role: m.role === 'agent' ? 'assistant' : m.role,\n      content: m.content,\n    })),\n  ];\n\n  try {\n    const controller = new AbortController();\n    const timeout = setTimeout(() => controller.abort(), 60_000); // 60s timeout\n\n    const response = await fetch(`${apiBase}/chat/completions`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${apiKey}`,\n      },\n      body: JSON.stringify({\n        model,\n        messages: llmMessages,\n        stream: true,\n        temperature: 0.7,\n        max_tokens: 1024,\n        top_p: 0.9,\n      }),\n      signal: controller.signal,\n    });\n\n    clearTimeout(timeout);\n\n    if (!response.ok) {\n      const errText = await response.text().catch(() => 'Unknown error');\n      console.error(`[LLM] API error ${response.status}: ${errText}`);\n      return NextResponse.json(\n        { error: `LLM API hatasÄ± (${response.status}): ${errText}` },\n        { status: 502 }\n      );\n    }\n\n    if (!response.body) {\n      return NextResponse.json({ error: 'LLM yanÄ±t stream yok' }, { status: 502 });\n    }\n\n    // Stream the SSE response back to client\n    const encoder = new TextEncoder();\n    const decoder = new TextDecoder();\n\n    const readable = new ReadableStream({\n      async start(streamController) {\n        const reader = response.body!.getReader();\n        let buffer = '';\n\n        try {\n          while (true) {\n            const { done, value } = await reader.read();\n            if (done) break;\n\n            buffer += decoder.decode(value, { stream: true });\n            const lines = buffer.split('\\n');\n            buffer = lines.pop() || '';\n\n            for (const line of lines) {\n              const trimmed = line.trim();\n              if (!trimmed || !trimmed.startsWith('data: ')) continue;\n\n              const data = trimmed.slice(6);\n              if (data === '[DONE]') {\n                streamController.enqueue(encoder.encode('data: [DONE]\\n\\n'));\n                continue;\n              }\n\n              try {\n                const json = JSON.parse(data);\n                const content = json.choices?.[0]?.delta?.content;\n                if (content) {\n                  streamController.enqueue(\n                    encoder.encode(`data: ${JSON.stringify({ content })}\\n\\n`)\n                  );\n                }\n              } catch {\n                // Skip malformed JSON chunks\n              }\n            }\n          }\n        } catch (err) {\n          console.error('[LLM] Stream read error:', err);\n        } finally {\n          streamController.close();\n        }\n      },\n    });\n\n    return new Response(readable, {\n      headers: {\n        'Content-Type': 'text/event-stream',\n        'Cache-Control': 'no-cache',\n        Connection: 'keep-alive',\n      },\n    });\n  } catch (err: unknown) {\n    if (err instanceof Error && err.name === 'AbortError') {\n      return NextResponse.json({ error: 'LLM isteÄŸi zaman aÅŸÄ±mÄ±na uÄŸradÄ± (60s)' }, { status: 504 });\n    }\n    console.error('[LLM] Unexpected error:', err);\n    return NextResponse.json({ error: 'Beklenmeyen LLM hatasÄ±' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}