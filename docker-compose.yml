# Production Docker Compose for ClawPazar Backend
# Usage: docker compose -f docker-compose.yml up -d

services:
  # ============================================================
  # 1. DATABASE: PostgreSQL with pgvector
  # ============================================================
  postgres:
    image: supabase/postgres:15.1.1.78
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?required}
      POSTGRES_DB: ${POSTGRES_DB:-clawpazar}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"

  # ============================================================
  # 2. SUPABASE AUTH (GoTrue)
  # ============================================================
  supabase-auth:
    image: supabase/gotrue:v2.158.1
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      API_EXTERNAL_URL: ${API_EXTERNAL_URL:-http://localhost:4000}
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-clawpazar}?search_path=auth
      GOTRUE_SITE_URL: ${SITE_URL:-http://localhost:3000}
      GOTRUE_JWT_SECRET: ${JWT_SECRET:?required}
      GOTRUE_JWT_EXP: 3600
      GOTRUE_JWT_DEFAULT_GROUP_NAME: authenticated
      GOTRUE_EXTERNAL_PHONE_ENABLED: "true"
      GOTRUE_SMS_PROVIDER: twilio
      GOTRUE_MAILER_AUTOCONFIRM: "false"
      GOTRUE_DISABLE_SIGNUP: "false"
    ports:
      - "9999:9999"

  # ============================================================
  # 3. SUPABASE REST (PostgREST)
  # ============================================================
  supabase-rest:
    image: postgrest/postgrest:v12.2.3
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGRST_DB_URI: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-clawpazar}
      PGRST_DB_SCHEMAS: public,storage
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET:?required}
      PGRST_DB_USE_LEGACY_GUCS: "false"
    ports:
      - "3001:3000"

  # ============================================================
  # 4. SUPABASE REALTIME
  # ============================================================
  supabase-realtime:
    image: supabase/realtime:v2.30.34
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PORT: 4001
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: ${POSTGRES_DB:-clawpazar}
      DB_AFTER_CONNECT_QUERY: "SET search_path TO _realtime"
      DB_ENC_KEY: ${REALTIME_ENC_KEY:-supabaserealtime}
      API_JWT_SECRET: ${JWT_SECRET}
      SECRET_KEY_BASE: ${REALTIME_SECRET_KEY_BASE:-your-secret-key-base-at-least-64-chars-long}
    ports:
      - "4001:4001"

  # ============================================================
  # 5. SUPABASE STORAGE
  # ============================================================
  supabase-storage:
    image: supabase/storage-api:v1.0.6
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      ANON_KEY: ${SUPABASE_ANON_KEY:?required}
      SERVICE_KEY: ${SUPABASE_SERVICE_KEY:?required}
      POSTGREST_URL: http://supabase-rest:3000
      PGRST_JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-clawpazar}
      FILE_SIZE_LIMIT: 52428800 # 50MB
      STORAGE_BACKEND: file
      FILE_STORAGE_BACKEND_PATH: /var/lib/storage
      TENANT_ID: stub
      REGION: eu-central-1
      GLOBAL_S3_BUCKET: clawpazar-storage
    volumes:
      - storage-data:/var/lib/storage
    ports:
      - "5000:5000"

  # ============================================================
  # 6. CLAWPAZAR API SERVER
  # ============================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      supabase-auth:
        condition: service_started
      supabase-rest:
        condition: service_started
    ports:
      - "${API_PORT:-4000}:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      SUPABASE_URL: http://supabase-rest:3000
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      JWT_SECRET: ${JWT_SECRET}
      # iyzico
      IYZICO_API_KEY: ${IYZICO_API_KEY:?required}
      IYZICO_SECRET_KEY: ${IYZICO_SECRET_KEY:?required}
      IYZICO_BASE_URL: ${IYZICO_BASE_URL:-https://sandbox-api.iyzipay.com}
      # External URLs
      API_URL: ${API_EXTERNAL_URL:-http://localhost:4000}
      FRONTEND_URL: ${SITE_URL:-http://localhost:3000}
      # WhatsApp
      WHATSAPP_VERIFY_TOKEN: ${WHATSAPP_VERIFY_TOKEN}
      WHATSAPP_ACCESS_TOKEN: ${WHATSAPP_ACCESS_TOKEN}
      # Telegram
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"

  # ============================================================
  # 6b. CLAWPAZAR FRONTEND (Next.js)
  # ============================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - api
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:4000
      NEXT_PUBLIC_SUPABASE_URL: http://localhost:3001
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      NEXT_PUBLIC_WS_URL: ws://localhost:4000
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

  # ============================================================
  # 6c. MCP SERVER (Agent Interface)
  # ============================================================
  mcp:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - api
    environment:
      CLAWPAZAR_API_URL: http://api:4000
      CLAWPAZAR_TOKEN: ${MCP_SERVICE_TOKEN:-}
    command: [ "node", "mcp/mcp-server.ts" ]
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"

  # ============================================================
  # 7. NGINX REVERSE PROXY
  # ============================================================
  nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    depends_on:
      - api
      - supabase-rest
      - supabase-auth
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"

  # ============================================================
  # 8. MONITORING: Prometheus + Grafana
  # ============================================================
  prometheus:
    image: prom/prometheus:v2.51.0
    restart: unless-stopped
    volumes:
      - ./infra/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    profiles: [ "monitoring" ]

  grafana:
    image: grafana/grafana:10.4.0
    restart: unless-stopped
    depends_on:
      - prometheus
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
    ports:
      - "3002:3000"
    profiles: [ "monitoring" ]

volumes:
  pgdata:
    driver: local
  storage-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
